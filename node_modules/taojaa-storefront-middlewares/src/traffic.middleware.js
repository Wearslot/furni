const requestIp = require('request-ip');
const { apiPost } = require('taojaa-storefront-helpers/src/api');

const trafficMiddleware = async (request, response, next) => {

    try {
        const link = request.query.referer || '';
        const ip_address = requestIp.getClientIp(request);
        const source_group = _getReferralGroup(link);
        const source_name = _getReferralName(link);

        const payload = { ip_address, source_group, source_name, link, location: request.originalUrl }
        await apiPost(`/${request.store.store_id}/traffic`, payload);

        next();
    } catch (error) {
        return response.errorHandler(error, request, response, next);
    }
}

const _getReferralGroup = (referralLink) => {
    const socialMediaPattern = /(facebook|twitter|instagram|linkedin)\.com/i;
    const emailPattern = /mail\.google\.com|mail\.yahoo\.com|outlook\.com/i;
    const googlePattern = /google\./i;
    const directPattern = /taojaa\.shop/i;

    if (referralLink === "") {
        return 'Direct';
    }

    if (socialMediaPattern.test(referralLink)) {
        return 'Social Media';
    } else if (emailPattern.test(referralLink)) {
        return 'Email';
    } else if (googlePattern.test(referralLink)) {
        return 'Google';
    } else if (directPattern.test(referralLink)) {
        return 'Direct';
    } else {
        return 'Referral';
    }
}

const _getReferralName = (referralLink) => {

    if (referralLink === "") {
        return 'Direct';
    }

    const url = new URL(referralLink);
    const domain = url.hostname.split('.').slice(-2).join('.');
    return domain;
}


module.exports = trafficMiddleware;